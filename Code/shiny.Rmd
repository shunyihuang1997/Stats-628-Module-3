---
title: "Untitled"
output: html_document
date: "2022-11-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r}
library(shiny)
library(shinyvalidate)
library(shinyjs)
library(tidyverse)
library(WVPlots)
library(rsconnect)
library(reticulate)
library(wordcloud2)
library(wordcloud)
library(RColorBrewer)
source_python("./app.py")
#use_condaenv("base")

#CA_Asian_business_review = read.csv('CA_Asian_business_review.csv')
```


```{python}
import pandas as pd
import matplotlib.pyplot as plt
import collections
from sklearn import preprocessing

import numpy as np
from tqdm import tqdm
import chardet
from collections import Counter
import seaborn as sns
import matplotlib.pyplot as plt
import plotly.express as px

from nltk.stem import WordNetLemmatizer
import nltk
from sklearn.feature_extraction.text import CountVectorizer
from sklearn.feature_extraction.text import TfidfVectorizer
from wordcloud import WordCloud
import textblob
from collections import defaultdict
from nltk.corpus import stopwords
from nltk.tokenize import word_tokenize
import re
from sklearn.linear_model import LogisticRegression
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
import math
from nltk import bigrams,trigrams,ngrams
from collections import Counter
from sklearn.metrics import confusion_matrix
from nltk import everygrams, word_tokenize
from sklearn.model_selection import GridSearchCV
from sklearn.tree import DecisionTreeClassifier
from nltk.stem import WordNetLemmatizer
from sklearn.metrics import precision_recall_curve
from sklearn.metrics import plot_confusion_matrix
CA_Asian_business_review = pd.read_csv('CA_Asian_business_review.csv',low_memory=False)
CA_Asian_business_review = CA_Asian_business_review[CA_Asian_business_review['is_open'] != 0].reset_index(drop = True)
```




```{python}
################## word cloud #########################
def show_word_cloud(sentiment, business_name):
  new_df= CA_Asian_business_review[CA_Asian_business_review['sentiment'] == sentiment].reset_index(drop=True)
  new_df= new_df[new_df['name'] == business_name].reset_index(drop=True)
  w_c = ""
  for i in range(len(new_df)):
    cur_list = new_df.loc[i,'text_cleaned'].split(',')
    for word in cur_list:
      word = word[2:-1]
      w_c += "".join(word)+ " "
  
  
  wordcloud_final = WordCloud(width = 800, height = 800, background_color ='white',min_font_size = 10, collocation_threshold = 3, min_word_length=3).generate(w_c)
  
  
  plt.imshow(wordcloud_final)
  plt.title(str(sentiment))
  plt.axis("off")
  plt.tight_layout(pad = 0)
  plt.show()
```



```{python}
######################## N-gram word frequency ##########################
def generate_N_grams(text,ngram):
  temp=zip(*[text[i:] for i in range(0,ngram)])
  ans=[' '.join(ngram) for ngram in temp]
  return ans


#Plot top 15 positive ngram word
def n_gram_positive(num_gram,business_name):
  positive_dict = defaultdict(int)
  new_df = CA_Asian_business_review[CA_Asian_business_review.sentiment == 'Positive']
  new_df = new_df[new_df.name == business_name]
  for text in new_df.text_cleaned:
    cur_list = text.split(',')
    for word in generate_N_grams(cur_list,num_gram):
      word = word[2:-1]
      positive_dict[word] += 1
          
          
  df_positive = pd.DataFrame(sorted(positive_dict.items(), key = lambda x : x[1], reverse= True))
  
  plt.figure(figsize=(6,2))
  plt.bar(df_positive[0][:15], df_positive[1][:15], color = 'green', width = 0.3)
  plt.xticks(rotation = 35)
  plt.ylabel("Count")
  plt.title("Top 10 positive")
  plt.xticks(fontsize = 10)
  plt.yticks(fontsize = 10)
  plt.tight_layout()
  plt.show()
  
  
#Plot top 15 negative ngram word
def n_gram_negative(num_gram,business_name):
  negative_dict = defaultdict(int)
  new_df = CA_Asian_business_review[CA_Asian_business_review.sentiment == 'Negative']
  new_df = new_df[new_df.name == business_name]
  for text in new_df.text_cleaned:
    cur_list = text.split(',')
    for word in generate_N_grams(cur_list,num_gram):
      word = word[2:-1]
      negative_dict[word] += 1
          
          
  df_negative = pd.DataFrame(sorted(negative_dict.items(), key = lambda x : x[1], reverse= True))
  
  plt.figure(figsize=(6,2))
  plt.bar(df_negative[0][:15], df_negative[1][:15], color = 'red', width = 0.3)
  plt.xticks(rotation = 35)
  plt.ylabel("Count")
  plt.title("Top 10 negative")
  plt.xticks(fontsize = 10)
  plt.yticks(fontsize = 10)
  plt.tight_layout()
  plt.show()
  

```




```{python}
def parking_scatter():
  has_parking = CA_Asian_business_review[CA_Asian_business_review['lot'] == True]
  no_parking = CA_Asian_business_review[CA_Asian_business_review['lot'] == False]
  
  color_scale = [(0, 'orange'), (1,'red')]
  fig = px.scatter_mapbox(CA_Asian_business_review, 
                          lat="latitude", 
                          lon="longitude", 
                          hover_name="name", 
                          hover_data=["average_stars",'address'],
                          color="lot",
                          color_continuous_scale=color_scale,
                          size="average_stars",
                          zoom=8, 
                          height=800,
                          width=800)
  
  fig.update_layout(mapbox_style="open-street-map")
  fig.update_layout(margin={"r":0,"t":0,"l":0,"b":0})
  fig.show()
```


```{python}
parking_scatter()
```






```{r}
ui = fluidPage(
  titlePanel('Your customer review and satisfication analysis'),
  column(3,
     wellPanel(
selectInput('business_name','Select business name', choice = unique(CA_Asian_business_review$name)),  
   numericInput('n_gram','length of text', value = 1, min = 1, max = 10) )
    ),

    column(3,  plotOutput('wordcloud_positive'), plotOutput('n_gram_positive')),
    column(3,  plotOutput('wordcloud_neutral'), plotOutput('n_gram_negative')),
    column(3,  plotOutput('wordcloud_negative')),
    plotOutput('parking_scatter')

)


server = function(input, output){
  output$wordcloud_positive = renderPlot({
    py$show_word_cloud('Positive',input$business_name)
  })
  output$wordcloud_neutral = renderPlot({
    py$show_word_cloud('Neutral',input$business_name)
  })
  output$wordcloud_negative = renderPlot({
    py$show_word_cloud('Negative',input$business_name)
  })
  
  output$n_gram_positive = renderPlot({
    py$n_gram_positive(input$n_gram, input$business_name)
  })
  output$n_gram_negative = renderPlot({
    py$n_gram_negative(input$n_gram, input$business_name)
  })
  
  output$parking_scatter = renderPlot(({
    py$parking_scatter()
  }))
}

shinyApp(ui, server)
```










```{python}
good_word = ['nice','affordable','delicious','fantastic','excellent','wonderful','terrific']
bad_word = ['bad','terrible','awful','horrible']
neutral_word = ['average','mediocre','adequate','ordinary','decent']
```




```{python}

def word_sanity_check (word):
    count_dict = {}
    for i in range(len(CA_Asian_business_review)):
        cur_star = CA_Asian_business_review.loc[i,'comment_star']
        cur_review = CA_Asian_business_review.loc[i,'text_cleaned']
        if cur_star not in count_dict:
            count_dict[cur_star] = 1
        elif word in cur_review:
            count_dict[cur_star] += 1
    count_dict = collections.OrderedDict(sorted(count_dict.items()))
    return count_dict


def word_freq(word_ls):
    ls_len = len(word_ls)
    ls_row = 3
    ls_col = 3
    for i in range(len(word_ls)):
        plt.tight_layout()
        cur_word = word_ls[i]
        cur_dict = word_sanity_check(cur_word)
        plt.subplot(ls_row,ls_col,i+1)
        plt.bar(cur_dict.keys(),cur_dict.values())
        plt.title(cur_word)
        plt.xlabel('rating')
        plt.ylabel('frequency')

    
word_freq(neutral_word)
plt.show()
```


```{python}
word_freq(good_word)
plt.show()
```


```{r}

```




















